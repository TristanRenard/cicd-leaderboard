<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üèÜ CI/CD Leaderboard</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #0d1117; color: #c9d1d9; min-height: 100vh; padding: 2rem; }
    h1 { text-align: center; font-size: 2.5rem; margin-bottom: 0.5rem; }
    .subtitle { text-align: center; color: #8b949e; margin-bottom: 2rem; font-size: 0.9rem; }
    .podium { display: flex; justify-content: center; align-items: flex-end; gap: 1rem; margin-bottom: 3rem; }
    .podium-slot { display: flex; flex-direction: column; align-items: center; }
    .podium-slot.first { order: 2; }
    .podium-slot.second { order: 1; }
    .podium-slot.third { order: 3; }
    .podium-card { background: #161b22; border: 1px solid #30363d; border-radius: 12px; padding: 1.5rem; text-align: center; width: min(260px, 30vw); }
    .podium-card.gold { border-color: #ffd700; box-shadow: 0 0 20px rgba(255, 215, 0, 0.2); }
    .podium-card.silver { border-color: #c0c0c0; }
    .podium-card.bronze { border-color: #cd7f32; }
    .podium-base { width: min(260px, 30vw); border-radius: 8px 8px 0 0; margin-top: 8px; }
    .podium-base.first { height: 120px; background: linear-gradient(180deg, #ffd700 0%, #b8960f 100%); }
    .podium-base.second { height: 85px; background: linear-gradient(180deg, #c0c0c0 0%, #808080 100%); }
    .podium-base.third { height: 55px; background: linear-gradient(180deg, #cd7f32 0%, #8b5a1e 100%); }
    .podium-rank { font-size: 2rem; }
    .podium-name { font-size: 1.3rem; font-weight: bold; margin: 0.5rem 0; }
    .podium-score { font-size: 1.8rem; font-weight: bold; color: #58a6ff; }
    .podium-bonus { font-size: 0.9rem; color: #f0883e; }
    .table-container { max-width: 1200px; margin: 0 auto; }
    table { width: 100%; border-collapse: collapse; background: #161b22; border-radius: 8px; overflow: hidden; }
    th { background: #21262d; padding: 12px 16px; text-align: left; font-weight: 600; font-size: 0.85rem; text-transform: uppercase; color: #8b949e; }
    td { padding: 12px 16px; border-top: 1px solid #21262d; }
    tr:hover td { background: #1c2128; }
    .rank { font-weight: bold; font-size: 1.2rem; }
    .team-name { font-weight: 600; }
    .team-members { color: #8b949e; font-size: 0.85rem; }
    .score { font-weight: bold; font-size: 1.1rem; color: #58a6ff; }
    .score-bonus { color: #f0883e; font-size: 0.85rem; font-weight: normal; }
    .bar { background: #21262d; border-radius: 4px; height: 8px; width: 100%; min-width: 100px; }
    .bar-fill { height: 100%; border-radius: 4px; background: linear-gradient(90deg, #238636, #2ea043); transition: width 0.5s; }
    .checks { display: flex; flex-wrap: wrap; gap: 4px; }
    .check { font-size: 0.75rem; padding: 2px 6px; border-radius: 4px; white-space: nowrap; }
    .check.pass { background: #0d2818; color: #3fb950; }
    .check.fail { background: #2d1214; color: #f85149; }
    .check.bonus-pass { background: #2a1f00; color: #f0883e; }
    .check.bonus-fail { background: #1c1c1c; color: #484f58; }
    .details-btn { background: #21262d; border: 1px solid #30363d; color: #c9d1d9; padding: 4px 10px; border-radius: 6px; cursor: pointer; font-size: 0.8rem; }
    .details-btn:hover { background: #30363d; }
    .detail-row { display: none; }
    .detail-row.open { display: table-row; }
    .detail-cell { padding: 16px; background: #0d1117; }
    .detail-section { margin-bottom: 8px; font-weight: 600; color: #8b949e; font-size: 0.8rem; text-transform: uppercase; }
    .repo-link { color: #58a6ff; text-decoration: none; }
    .repo-link:hover { text-decoration: underline; }
    .deploy-link { color: #3fb950; text-decoration: none; font-size: 0.85rem; }
    .updated { text-align: center; color: #484f58; margin-top: 2rem; font-size: 0.8rem; }
    .legend { max-width: 1200px; margin: 2rem auto 0; display: flex; gap: 2rem; justify-content: center; flex-wrap: wrap; color: #8b949e; font-size: 0.85rem; }
    .legend-item { display: flex; align-items: center; gap: 0.4rem; }
    .legend-dot { width: 10px; height: 10px; border-radius: 50%; }
    .legend-dot.fund { background: #58a6ff; }
    .legend-dot.inter { background: #d29922; }
    .legend-dot.adv { background: #a371f7; }
    .legend-dot.bonus { background: #f0883e; }
    @media (max-width: 768px) {
      body { padding: 1rem; }
      h1 { font-size: 1.8rem; }
      .podium { flex-direction: column; align-items: center; }
      .podium-slot { order: unset !important; }
      .podium-base { display: none; }
      .podium-card, .podium-base { width: 100%; }
      .checks { display: none; }
    }
  </style>
</head>
<body>
  <h1>üèÜ CI/CD Leaderboard</h1>
  <div class="subtitle" id="subtitle">Chargement...</div>

  <div class="podium" id="podium"></div>

  <div class="table-container">
    <table>
      <thead>
        <tr>
          <th>#</th>
          <th>√âquipe</th>
          <th>Score</th>
          <th>Progression</th>
          <th>Checks</th>
          <th></th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>

  <div class="legend">
    <div class="legend-item"><div class="legend-dot fund"></div> Fondamentaux (60 pts)</div>
    <div class="legend-item"><div class="legend-dot inter"></div> Interm√©diaire (40 pts)</div>
    <div class="legend-item"><div class="legend-dot adv"></div> Avanc√© (30 pts)</div>
    <div class="legend-item"><div class="legend-dot bonus"></div> Bonus (25 pts)</div>
  </div>

  <div class="updated" id="updated"></div>

  <script>
    function formatReviewDetails(section) {
      if (!section) return '';
      // If details is a plain string
      if (typeof section.details === 'string') return section.details;
      // If details is an object with sub-scores
      if (section.details && typeof section.details === 'object') {
        return Object.entries(section.details)
          .map(([k, v]) => `<div style="margin-left:8px;font-size:0.85rem"><b>${k.replace(/_/g, ' ')}</b>: ${v}</div>`)
          .join('');
      }
      if (section.notes && typeof section.notes === 'string') return section.notes;
      return '';
    }

    const MEDALS = ['ü•á', 'ü•à', 'ü•â'];
    const PODIUM_CLASSES = ['gold', 'silver', 'bronze'];

    async function load() {
      const res = await fetch('scores.json');
      const data = await res.json();
      const bonusPossible = data.bonus_possible || 0;

      // Load reviews if available
      let reviews = {};
      try {
        const revRes = await fetch('reviews.json');
        if (revRes.ok) {
          const revData = await revRes.json();
          for (const r of revData.teams || []) {
            reviews[r.repo] = r;
          }
        }
      } catch { /* no reviews yet */ }

      document.getElementById('subtitle').textContent =
        `${data.teams.length} √©quipes ¬∑ ${data.total_possible} points${bonusPossible ? ` + ${bonusPossible} bonus` : ''}`;

      // Podium (2-1-3 layout like a real podium)
      const podium = document.getElementById('podium');
      const slotClasses = ['first', 'second', 'third'];
      data.teams.slice(0, 3).forEach((t, i) => {
        const bonusStr = t.bonus > 0 ? `<div class="podium-bonus">+${t.bonus} bonus</div>` : '';
        podium.innerHTML += `
          <div class="podium-slot ${slotClasses[i]}">
            <div class="podium-card ${PODIUM_CLASSES[i]}">
              <div class="podium-rank">${MEDALS[i]}</div>
              <div class="podium-name">${t.team}</div>
              <div class="podium-score">${t.total} pts</div>
              ${bonusStr}
              <div class="team-members">${t.members.join(', ')}</div>
            </div>
            <div class="podium-base ${slotClasses[i]}"></div>
          </div>`;
      });

      // Table
      const tbody = document.getElementById('tbody');
      data.teams.forEach((t) => {
        const pct = Math.round((t.total / data.total_possible) * 100);

        // Core checks
        const checks = Object.entries(t.results)
          .map(([k, v]) => `<span class="check ${v.pass ? 'pass' : 'fail'}" title="${v.detail}">${v.pass ? '‚úÖ' : '‚ùå'} ${v.label}</span>`)
          .join('');

        // Bonus checks ‚Äî only show earned ones
        const bonusChecks = t.bonusResults ? Object.entries(t.bonusResults)
          .filter(([k, v]) => v.pass)
          .map(([k, v]) => `<span class="check bonus-pass" title="${v.detail}">‚≠ê ${v.label}</span>`)
          .join('') : '';

        // Detail rows
        const coreDetails = Object.entries(t.results)
          .map(([k, v]) => `<div><span class="check ${v.pass ? 'pass' : 'fail'}">${v.pass ? '‚úÖ' : '‚ùå'} ${v.label} (${v.pass ? v.points : 0}/${v.points})</span> ‚Äî ${v.detail}</div>`)
          .join('');

        const earnedBonus = t.bonusResults ? Object.entries(t.bonusResults).filter(([k, v]) => v.pass) : [];
        const bonusDetails = earnedBonus
          .map(([k, v]) => `<div><span class="check bonus-pass">‚≠ê ${v.label} (+${v.points})</span> ‚Äî ${v.detail}</div>`)
          .join('');

        const bonusScore = t.bonus > 0 ? `<span class="score-bonus"> +${t.bonus}</span>` : '';

        // Review scores
        const review = reviews[t.repo];
        const reviewBadge = review
          ? `<span class="check bonus-pass" title="${review.summary || ''}">üìù Review ${review.total}/20</span>`
          : '';
        const reviewDetails = review
          ? `<div class="detail-section" style="margin-top:12px">üìù Code Review (${review.total}/20)</div>
             <div><span class="check ${review.code_quality?.score >= 6 ? 'pass' : 'fail'}">Code: ${review.code_quality?.score || 0}/10</span> ‚Äî ${formatReviewDetails(review.code_quality)}</div>
             <div><span class="check ${review.documentation?.score >= 6 ? 'pass' : 'fail'}">Docs: ${review.documentation?.score || 0}/10</span> ‚Äî ${formatReviewDetails(review.documentation)}</div>
             ${review.summary ? `<div style="color:#8b949e;margin-top:4px;font-style:italic">${review.summary}</div>` : ''}
             ${review.tips?.length ? `<div style="margin-top:8px"><b style="color:#f0883e">üí° Tips:</b><ul style="margin:4px 0 0 16px;color:#c9d1d9;font-size:0.85rem">${review.tips.map(t => '<li>' + t + '</li>').join('')}</ul></div>` : ''}`
          : '';

        tbody.innerHTML += `
          <tr>
            <td class="rank">${t.rank <= 3 ? MEDALS[t.rank-1] : t.rank}</td>
            <td>
              <div class="team-name"><a class="repo-link" href="https://github.com/${t.repo}" target="_blank">${t.team}</a></div>
              <div class="team-members">${t.members.join(', ')}</div>
              ${t.deploy_url ? `<a class="deploy-link" href="${t.deploy_url}" target="_blank">üåê ${t.deploy_url}</a>` : ''}
            </td>
            <td class="score">${t.total}<span style="color:#8b949e;font-weight:normal">/${data.total_possible}</span>${bonusScore}</td>
            <td><div class="bar"><div class="bar-fill" style="width:${pct}%"></div></div></td>
            <td class="checks">${checks}${bonusChecks ? '<br>' + bonusChecks : ''}${reviewBadge ? '<br>' + reviewBadge : ''}</td>
            <td><button class="details-btn" onclick="toggleDetail(this)">D√©tails</button></td>
          </tr>
          <tr class="detail-row">
            <td colspan="6" class="detail-cell">
              <div class="detail-section">Core</div>
              ${coreDetails}
              ${bonusDetails ? `<div class="detail-section" style="margin-top:12px">‚≠ê Bonus</div>${bonusDetails}` : ''}
              ${reviewDetails}
            </td>
          </tr>`;
      });

      // Updated
      const d = new Date(data.generated_at);
      document.getElementById('updated').textContent =
        `Derni√®re mise √† jour : ${d.toLocaleString('fr-FR')}`;
    }

    function toggleDetail(btn) {
      const detailRow = btn.closest('tr').nextElementSibling;
      detailRow.classList.toggle('open');
      btn.textContent = detailRow.classList.contains('open') ? 'Fermer' : 'D√©tails';
    }

    load();
  </script>
</body>
</html>
